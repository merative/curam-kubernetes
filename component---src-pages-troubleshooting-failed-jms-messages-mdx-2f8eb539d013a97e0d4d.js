"use strict";(self.webpackChunkcuram_kubernetes=self.webpackChunkcuram_kubernetes||[]).push([[5295],{8213:function(e,a,n){n.r(a),n.d(a,{_frontmatter:function(){return i},default:function(){return g}});var t=n(45),s=(n(6540),n(5680)),o=n(4330);const r=["components"],i={},m=e=>function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,s.yg)("div",a)},l=m("Caption"),p=m("InlineNotification"),u={_frontmatter:i},d=o.A;function g(e){let{components:a}=e,n=(0,t.A)(e,r);return(0,s.yg)(d,Object.assign({},u,n,{components:a,mdxType:"MDXLayout"}),(0,s.yg)("h2",null,"Introduction"),(0,s.yg)("p",null,"It would be unusual for JMS processing to fail; but, if messages do fail that is why we define retry counts, and error and dead message queues.\nThere are two common contexts for JMS failures:"),(0,s.yg)("ul",null,(0,s.yg)("li",{parentName:"ul"},"Message production: messages to MQ from Liberty."),(0,s.yg)("li",{parentName:"ul"},"Message consumption: message processing in Liberty for messages from MQ.")),(0,s.yg)("h2",null,"Message Production Failures"),(0,s.yg)("p",null,"If the production of a JMS message fails, a Java exception is thrown in Liberty (shown in the application server logs), the transaction fails, and the message is never processed by MQ."),(0,s.yg)("p",null,"For example, if an MQ queue fills up, the following exception would be seen in the stack trace. This points back to the issue in MQ and other related exceptions would identify the failing queue."),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre"},"traces in the WebSphere Liberty log files:\nCaused by: com.ibm.mq.MQException: JMSCMQ0001:\nIBM MQ call failed with compcode '2' ('MQCC_FAILED') reason '2053' ('MQRC_Q_FULL').\n")),(0,s.yg)("h2",null,"Message Consumption Failures"),(0,s.yg)("p",null,"The JMS configuration for Cúram specifies a hierarchy of queues, from the normal queue, to an error queue, and, finally, to the dead message queue.\nFigure 1 illustrates this flow of JMS messages for SPM."),(0,s.yg)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"701px"}},"\n      ",(0,s.yg)("span",{parentName:"span",className:"gatsby-resp-image-background-image",style:{paddingBottom:"60.06944444444444%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABw0lEQVQoz3VRa2/aQBD0//9DbUkwhTahaZCi+oUxAYPf4Mf5fXe+u70KUCIjtaP9stqbnZtZxQk2VmCavm4FhhNvClQQTNzTTvc0yzfMQN/F2xKVPe7fE8fwdNM3rNA4JG5VVooVmb/dl5mmPm+f9EiLk1gIbp/WM12dG98X64Xm/cnSdODUPBlzaz7T1F+7pR2uizxXojyI6zBAXlj6cRW1XSsBsjaN6sAvvLDyT3WCMQbg5zYJkB8UXlSHaXUmhCgYEyklJYMQQt4DhKBkAPho4fJMfvZSKl2TS2j65sRpAazhnI/5fMANCiW0glcNCjmj46nSp2+yfK6CKct/crTK84zz2xeuCjRh2QIdH+tAhXKJMg8TOiLnmqxfy2DB0Iuo3vLsLAR8koGeGVoif15HP6B6RZlHKRuR21JCx1lDupwPLWPs3jdnpBxwKaEH3g0DGUejYIxvKlwAxpSNPAsATCihwygjee+57y5BggC4rKx8v9K1fuv0zibXNdr315zFrYQQMIIyDMPHJS77+/dt8u1L9DgJJ1/T+QyuZPkfacW27cPh4Lquu9+7x+N2tdo8TBx1aj8+bNTp3nHc2/Rf+As7oqESNib2egAAAABJRU5ErkJggg==')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,s.yg)("picture",{parentName:"span"},"\n          ",(0,s.yg)("source",{parentName:"picture",srcSet:["/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/0eda2/curam_jmsqueue_message_flow.webp 288w","/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/460e2/curam_jmsqueue_message_flow.webp 576w","/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/178f4/curam_jmsqueue_message_flow.webp 701w"],sizes:"(max-width: 701px) 100vw, 701px",type:"image/webp"}),"\n          ",(0,s.yg)("source",{parentName:"picture",srcSet:["/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/7fc1e/curam_jmsqueue_message_flow.png 288w","/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/a5df1/curam_jmsqueue_message_flow.png 576w","/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/ed6d3/curam_jmsqueue_message_flow.png 701w"],sizes:"(max-width: 701px) 100vw, 701px",type:"image/png"}),"\n          ",(0,s.yg)("img",{parentName:"picture",className:"gatsby-resp-image-image",src:"/curam-kubernetes/static/ea47a9161e1e20957d4a5ed2b528902d/ed6d3/curam_jmsqueue_message_flow.png",alt:"Cúram on Kubernetes - Cúram JMS queue message flow",title:"Cúram on Kubernetes - Cúram JMS queue message flow",loading:"lazy",decoding:"async",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"}}),"\n        "),"\n    "),(0,s.yg)(l,{mdxType:"Caption"},(0,s.yg)("p",null,(0,s.yg)("em",{parentName:"p"},"Figure 1:")," Cúram JMS queue message flow")),(0,s.yg)("p",null,"JMS messages are usually handled within one of the three queues: ",(0,s.yg)("inlineCode",{parentName:"p"},"DPEnactment"),", ",(0,s.yg)("inlineCode",{parentName:"p"},"WorkflowEnactment"),", or ",(0,s.yg)("inlineCode",{parentName:"p"},"WorkflowActivity"),"; and, if necessary, are given up to five retry attempts, which is a configurable value in MQ ",(0,s.yg)("inlineCode",{parentName:"p"},"(BOTHRESH(5))"),"."),(0,s.yg)("p",null,"Should the message not succeed at that point it is routed to its associated error or exception queue as shown in the diagram - ",(0,s.yg)("inlineCode",{parentName:"p"},"DPEnactment")," to ",(0,s.yg)("inlineCode",{parentName:"p"},"DPError"),", and ",(0,s.yg)("inlineCode",{parentName:"p"},"WorkflowEnactment"),"/",(0,s.yg)("inlineCode",{parentName:"p"},"WorkflowActivity")," to ",(0,s.yg)("inlineCode",{parentName:"p"},"WorkflowError"),"."),(0,s.yg)("p",null,"At this point, Cúram, or custom error processing, can take over, depending on the message type and the configuration.  Similarly, the error queues are defined to retry up to five times."),(0,s.yg)("p",null,"Should the error queue processing fail, the message is finally routed to the ",(0,s.yg)("inlineCode",{parentName:"p"},"CuramDeadMessageQueue"),", specified as the MQ dead letter queue.\nThe message will remian there until it is either resent to its originating queue, or is deleted. How to do that is the subject of this document."),(0,s.yg)("p",null,"Normally, the only concern with respect to JMS message failures is what ends up in the dead message queue, since that represents work that should have been processed but wasn’t."),(0,s.yg)("p",null,"However, there are some error queue interventions that may be necessary, which are outside the scope of this document."),(0,s.yg)("p",null,"For more information about how Cúram Express Rules processing will transfer messages routed to the JMS error queue to batch, see ",(0,s.yg)("strong",{parentName:"p"},"Dependency Manager deferred processing")," in the ",(0,s.yg)("em",{parentName:"p"},"Cúram Express Rules Reference Manual"),"."),(0,s.yg)(p,{mdxType:"InlineNotification"},(0,s.yg)("p",null,"Cúram PDF documentation is available to download from ",(0,s.yg)("a",{parentName:"p",href:"https://curam-spm-devops.github.io/wh-support-docs/spm/pdf-documentation/"},"Cúram Support Docs"),".")),(0,s.yg)("p",null,"The dead message queue in MQ, ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE"),", should be monitored to ensure that messages are not failing to be processed, which should also be evidenced by Java exceptions in the Liberty logs, and a non-zero queue depth in MQ.\nFor instance, this MQSC command displays the current queue depth for the dead message queue:"),(0,s.yg)("pre",null,(0,s.yg)("code",{parentName:"pre"},"DISPLAY QUEUE(QN.CURAMDEADMESSAGEQUEUE) CURDEPTH\n")),(0,s.yg)("p",null,"There are a number of options for processing messages from ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE"),", provided by two MQ commands:"),(0,s.yg)("ul",null,(0,s.yg)("li",{parentName:"ul"},"The queue load and unload command: ",(0,s.yg)("a",{parentName:"li",href:"https://www.ibm.com/docs/en/ibm-mq/9.1?topic=reference-dmpmqmsg-queue-load-unload"},"dmpmqmsg")),(0,s.yg)("li",{parentName:"ul"},"The run dead-letter queue handler command: ",(0,s.yg)("a",{parentName:"li",href:"https://www.ibm.com/docs/en/ibm-mq/9.1?topic=reference-runmqdlq-run-dead-letter-queue-handler"},"runmqdlq"))),(0,s.yg)("p",null,"Important points to remember:"),(0,s.yg)(p,{kind:"info",mdxType:"InlineNotification"},(0,s.yg)("p",null,(0,s.yg)("strong",{parentName:"p"},"Note:")," When processing messages from ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE")," it’s essential to be aware of the original queue that the message came from.\nThat is, messages from multiple queues can be routed to ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE")," and routing those messages incorrectly will result in additional errors. The ",(0,s.yg)("inlineCode",{parentName:"p"},"dmpmqmsg")," command provides filtering options and the ",(0,s.yg)("inlineCode",{parentName:"p"},"runmqdlg")," command provides a rules table.")),(0,s.yg)(p,{kind:"info",mdxType:"InlineNotification"},(0,s.yg)("p",null,"Messages are processed as they arrive, with the exception of the dead message queue i.e, if messages from ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE")," are loaded into another queue, and they fail again, duplicate messages can appear, which can be confusing to resolve.\nTherefore, it is recommended that the dead message queue is cleared before processing its contents.")),(0,s.yg)("h3",null,"Dead Letter Messages Example"),(0,s.yg)("p",null,"This is a simple example illustrating the processing of dead letter messages:"),(0,s.yg)("ul",null,(0,s.yg)("li",{parentName:"ul"},(0,s.yg)("p",{parentName:"li"},"Unload the messages from the queue e.g., from the ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE")," queue in Queue Manager QM1:"),(0,s.yg)("pre",{parentName:"li"},(0,s.yg)("code",{parentName:"pre"},"$MQ_INSTALLATION_PATH/dmpmqmsg -m QM1 -i QN.CURAMDEADMESSAGEQUEUE -f dead_messages.mq\n")),(0,s.yg)("p",{parentName:"li"},"  This command would copy all of the messages on the queue into the specified file."),(0,s.yg)("p",{parentName:"li"},"  Replacing the ",(0,s.yg)("inlineCode",{parentName:"p"},"-i")," option with ",(0,s.yg)("inlineCode",{parentName:"p"},"-I")," would move the messages, leaving the queue empty."),(0,s.yg)("p",{parentName:"li"},"  To selectively process messages, use the search option (-s), for instance:"),(0,s.yg)("pre",{parentName:"li"},(0,s.yg)("code",{parentName:"pre"},"$MQ_INSTALLATION_PATH/dmpmqmsg -m QM1 -I QN.CURAMDEADMESSAGEQUEUE -s QN.DPENACTMENT  -dA -f DPENACTMENT.mq\n$MQ_INSTALLATION_PATH/dmpmqmsg -m QM1 -I QN.CURAMDEADMESSAGEQUEUE -s QN.WORKFLOWENACTMENT  -dA -f WORKFLOWENACTMENT.mq\n")),(0,s.yg)("p",{parentName:"li"},"  This would move the messages from the ",(0,s.yg)("inlineCode",{parentName:"p"},"QN.CURAMDEADMESSAGEQUEUE")," into the specified files based on the filter.\nThe ",(0,s.yg)("inlineCode",{parentName:"p"},"DISPLAY QUEUE(QN.CURAMDEADMESSAGEQUEUE) CURDEPTH")," command can now be used to confirm that all messages are accounted for.")),(0,s.yg)("li",{parentName:"ul"},(0,s.yg)("p",{parentName:"li"},"If the ",(0,s.yg)("inlineCode",{parentName:"p"},"-I")," option (or, optionally the ",(0,s.yg)("inlineCode",{parentName:"p"},"-p")," option) wasn’t used when running the ",(0,s.yg)("inlineCode",{parentName:"p"},"dmpmqmsg")," command to clear the dead message queue as its contents were processed, that should be done now using the MQSC command, for instance:"),(0,s.yg)("pre",{parentName:"li"},(0,s.yg)("code",{parentName:"pre"},"CLEAR QLOCAL (QN.CURAMDEADMESSAGEQUEUE)\n"))),(0,s.yg)("li",{parentName:"ul"},(0,s.yg)("p",{parentName:"li"},"Once the original problem is resolved that caused the errors, reload the messages. For example, using the previous filtered example:"),(0,s.yg)("pre",{parentName:"li"},(0,s.yg)("code",{parentName:"pre"},"$MQ_INSTALLATION_PATH/dmpmqmsg -m QM1 -o QN.DPENACTMENT -f DPENACTMENT.mq\n$MQ_INSTALLATION_PATH/dmpmqmsg -m QM1 -I QN.WORKFLOWENACTMENT -f WORKFLOWENACTMENT.mq\n")))))}g.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-troubleshooting-failed-jms-messages-mdx-2f8eb539d013a97e0d4d.js.map